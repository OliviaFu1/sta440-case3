---
title: "case3_code"
format: html
editor: visual
---

# Data

```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
```

```{r}
load("./emsData.RData")
```

# EDA

```{r}
# remove duplicated entries of the same call
# 5 duplicates
x <- x |>
  distinct(VEH.GRID, DT.DISP, .keep_all = TRUE)
```

## Problem in North

```{r}
x |>
  mutate(travelTime = DT.ARRIVE - DT.ENROUTE) |>
  ggplot(aes(x = travelTime)) +
  facet_wrap(~REF.GRID) +
  geom_histogram(bins = 25) +
  theme_minimal()
```

```{r}
x <- x |>
  mutate(travelTime = DT.ARRIVE - DT.ENROUTE,
         shortestTime = pmin(eTT.UA.NN, eTT.UA.FN, eTT.UA.So, eTT.UA.Ce, na.rm = TRUE))

x |>
  mutate(diff = travelTime - shortestTime) |>
  filter(REF.GRID == "1 North") |>
  ggplot(aes(x = diff)) +
  geom_histogram() +
  theme_minimal()
```

```{r}
ggplot(x,aes(x=REF.GRID, y= dispToClearTime))+geom_histogram(stat= "identity",position="dodge")


# difference in travel time (station to scene vs. scene to hospital)
ggplot(x,aes(x=observedTT,y=toHospitalTT,color=REF.GRID))+geom_point()+geom_smooth()

#difference in travel time ()
ggplot(x,aes(x=atHospitalDur,y=REF.GRID,color=DISPATCH.PRIORITY.NAME))+geom_boxplot()
ggplot(x,aes(x=observedTT,y=REF.GRID,color=DISPATCH.PRIORITY.NAME))+geom_boxplot()

```

## Actual vs. Estimated

```{r}
x <- x |>
  mutate(
    # actual observed time
    actual_time = as.numeric(difftime(DT.ARRIVE, DT.DISP, units = "secs")),

    # pick the correct estimate from each provider
    est_UA = case_when(
      BASE.NAME == "Company 1" ~ eTT.UA.So,
      BASE.NAME == "Company 9" ~ eTT.UA.Ce,
      TRUE ~ NA_real_
    ),
    est_Pe = case_when(
      BASE.NAME == "Company 1" ~ eTT.Pe.So,
      BASE.NAME == "Company 9" ~ eTT.Pe.Ce,
      TRUE ~ NA_real_
    ),
    est_Op = case_when(
      BASE.NAME == "Company 1" ~ eTT.Op.So,
      BASE.NAME == "Company 9" ~ eTT.Op.Ce,
      TRUE ~ NA_real_
    ),
    est_BG = case_when(
      BASE.NAME == "Company 1" ~ eTT.BG.So,
      BASE.NAME == "Company 9" ~ eTT.BG.Ce,
      TRUE ~ NA_real_
    )
  )
```

```{r}
act_est <- x |>
  select(actual_time, est_UA, est_Pe, est_Op, est_BG, BASE.NAME) |>
  pivot_longer(
    cols = starts_with("est_"),
    names_to = "Estimator",
    values_to = "est_time"
  )
```

```{r}
metrics <- act_est |>
  group_by(Estimator) |>
  summarise(
    MAE  = mean(abs(actual_time - est_time), na.rm = TRUE),
    RMSE = sqrt(mean((actual_time - est_time)^2, na.rm = TRUE)),
    Bias = mean(actual_time - est_time, na.rm = TRUE)
  )

metrics
```

```{r}
ggplot(act_est, aes(x = est_time, y = actual_time, color = BASE.NAME)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  facet_wrap(~ Estimator) +
  labs(
    title = "Actual vs. Estimated Travel Times",
    x = "Estimated travel time (seconds)",
    y = "Actual travel time (seconds)"
  ) +
  theme_minimal()
```

```{r}
act_est <- act_est |>
  mutate(error = actual_time - est_time)

ggplot(act_est, aes(x = Estimator, y = error, fill = Estimator)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Error Distribution by Estimator",
    y = "Error (seconds, actual âˆ’ estimated)",
    x = "Estimator"
  ) +
  theme_minimal()
```

## Comparing scenarios

```{r}
# S0: Central + South
x$S0 <- pmin(x$eTT.UA.Ce, x$eTT.UA.So, na.rm = TRUE)

# S1: Central + Near North
x$S1 <- pmin(x$eTT.UA.Ce, x$eTT.UA.NN, na.rm = TRUE)

# S2: Central + Far North
x$S2 <- pmin(x$eTT.UA.Ce, x$eTT.UA.FN, na.rm = TRUE)

# S3: Central + South + Near North
x$S3 <- pmin(x$eTT.UA.Ce, x$eTT.UA.So, x$eTT.UA.NN, na.rm = TRUE)

# S4: Central + South + Far North
x$S4 <- pmin(x$eTT.UA.Ce, x$eTT.UA.So, x$eTT.UA.FN, na.rm = TRUE)
```

```{r}
# shortest ETT regardless of system load

shortest_ett <- x |>
  select(S0, S1, S2, S3, S4, actual_time) |>
  pivot_longer(
    cols = everything(),
    names_to = "scenario",
    values_to = "time"
  )

ggplot(shortest_ett, aes(x = time)) +
  geom_histogram(position = "identity", bins = 50) +
  labs(
    title = "Shortest Travel Time Distributions by Scenario",
    x = "Travel time (seconds)",
    y = "Count",
    fill = "Scenario"
  ) +
  theme_minimal() +
  facet_wrap(~scenario)
```

### Consider System load (dispatch rule)

```{r}

```

---
title: "Case 3: Vance County EMS"
author: "Steph Reinke, Olivia Fu, Srika Gopal"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: false
  bookdown::html_document2:
    toc: true
    number_sections: true
    fig_caption: true
editor: visual
---

# Background and Motivation

Emergency medical service (EMS) response times can drastically impact patient outcomes. Vance County, North Carolina is a growing county that is interested in evaluating their current EMS ambulance placements. The county has three major regions, the North, Central, and the South. The population is mostly concentrated in the city of Henderson, located in the Central region. Currently, there are two EMS stations – one in the South with one ambulance, and one in the Central region with three ambulances. The North region does not have a dedicated station, raising concerns about delayed response times for residents in that area.

To address this, county officials are considering relocating one of the existing ambulances to the North. Two potential station locations are being evaluated: Near North and Far North. By either reassigning an ambulance from the Central or South station, four placement scenarios were proposed:

-   Scenario 0 (Current Setup): 1 in South, 3 in Central

-   Scenario 1: 0 in South, 3 in Central, 1 in Near North

-   Scenario 2: 0 in South, 3 in Central, 1 in Far North

-   Scenario 3: 1 in South, 2 in Central, 1 in Near North

-   Scenario 4: 1 in South, 2 in Central, 1 in Far North

**Research question:** Where should the ambulances be stationed to best serve Vance county?

# Data and Exploratory Analysis

To address this research question, we examined a dataset with real EMS call records from Vance County. Select identifying information, such as dates and addresses, was modified or removed to comply with HIPAA regulations; however, for the purposes of our analysis those changes are not relevant. The dataset includes key operational details for each call, such as location, emergency level, dispatch time, arrival time, etc. For each call, estimated travel times were obtained using the Google Maps API for all existing stations and the two proposed Northern station locations. Google Maps provided four types of travel time estimates for each call–station pair: best-guess, optimistic, pessimistic, and unadjusted. These estimates enabled us to compare response times across the five proposed ambulance placement scenarios.

We started by examining the spatial distribution of EMS calls across Vance County. We mapped call locations across Vance County and colored them by response time (Figure 1). Calls are densely concentrated in the Central region around the city of Henderson and become increasingly sparse with distance, particularly in the far North and South. Response times are shortest in the Central region and tend to be longer in the North and South. The vast majority of calls have response times under 10 minutes, with nearly all under 20 minutes.

Because four types of travel time estimates were available from the Google Maps API, we conducted an accuracy assessment to determine which estimate most closely aligned with actual recorded travel times. As shown in Table 1, although the optimistic estimate had the lowest mean absolute error (MAE) and root mean squared error (RMSE), it exhibited a positive bias, suggesting a tendency to underestimate travel times. We therefore chose to use the best-guess estimate (BG), which had the lowest bias. This can be seen visually in Figure 2, where the distribution of BG residuals is most centered around zero compared to the other estimates.

To simulate EMS responses, we established a dispatch rule in which each call is assigned to the nearest station with an available ambulance. More specifically, we used an availability matrix to identify overlapping calls. If the dispatch time of a call occurred before a previously dispatched ambulance became available, it was classified as a conflict. We then adjusted each station’s available ambulances by subtracting those already in use. Among stations with at least one available vehicle, the call was dispatched from the station with the shortest estimated travel time.

With this dispatch rule in place, we generated estimated travel times for all calls under each proposed scenario. Figure 3 summarizes the distribution of travel times across scenarios. Scenario 3 shows a greater proportion of calls reached within 0–6 minutes and fewer calls exceeding 15 minutes relative to the current setup. This preliminary evidence suggests that Scenario 3 may be the optimal choice in travel time performance.

# Model Rationale, Implementation, and Evaluation

## Rationale & Selection

We selected a two-stage modeling approach: a logistic regression to model whether estimated travel time changes from the baseline scenario, followed by a linear mixed-effects model to quantify how travel time changes when it does differ. This approach is justified both by the data structure and the nature of our dispatch system. In our simulation, many calls have identical estimated travel times across all four proposed scenarios and the baseline (S0). For example, calls located in the central often have the same optimal dispatch station under all scenarios, resulting in no variation. Including these repeated values directly in a continuous-response model would violate normality and constant variance assumptions because of the large number of zero differences.

To address this, our first model is a logistic regression predicting whether estimated travel time differs from baseline (change vs. no change). This allows us to estimate the probability that each scenario leads to a change in dispatch outcome.

Conditional on a change occurring, we then model the magnitude of that change using a linear mixed-effects model. The response variable is the difference in estimated travel time relative to baseline. We include a `Scenario*Region` interaction to assess both overall scenario effects and whether their impacts differ across geographic regions. Because each call contributes multiple observations (one per scenario), there is clear grouping in the data. Therefore, we include a random intercept at the call level to account for within-call correlation.

Exploratory residual analysis revealed heteroskedasticity across regions, so we incorporate region-specific residual variances using a `varIdent` variance structure. Attempts to also model variance by scenario resulted in singular fits, likely due to limited variability or nesting of scenarios within call-level random effects. A competing GLS model without random effects and with `Scenario*Region` variance structure had substantially worse AIC/BIC values (Table 4), which supports that accounting for call-level correlation and regional heterogeneity provides a better fit.

**Final model specifications:**

$$
\begin{aligned}
&\text{logit}\left[P(\text{Change}_i)\right] = \beta_0 + \beta_{\text{Scenario}} \\
& Y_{ij} = \beta_0 + \beta_{\text{Scenario}_j} + \beta_{\text{Region}_k} + \beta_{\text{Scenario}_j \times \text{Region}_k} + u_i + \varepsilon_{ijk},\quad u_i \sim N(0, \sigma_u^2), \quad\varepsilon_{ijk} \sim N(0, \sigma_{\text{Region}_k}^2)
\end{aligned}
$$

where $Y_{ij}$ is the travel time difference from baseline for call $i$ under scenario $j$.

## Implementation

For the logistic model, we created a binary indicator of whether estimated travel time changed from baseline and fit a generalized linear model using the `glm()` function in R with a binomial family and scenario as the predictor.

For the linear mixed-effects stage, we retained only rows where travel time differed from baseline and modeled the continuous difference using the `lme()` function in the `nlme` package. We specified a random intercept for each call (`random = ~1 | row_val`) and allowed the residual variance to differ by region using `weights = varIdent(form = ~1 | region)`.

## Evaluation

To evaluate whether the model provided a good fit for the data, we examined multiple residual plots. The residuals are normalized to account for the model’s variance structure. In the residuals vs. fitted values plot (Figure 6), the residuals are randomly scattered around zero without clear patterns or clustering, which suggests that the model’s mean structure is appropriate and that the variance has been reasonably modeled. The horizontal layering is expected due to the discrete set of fitted values from the scenario–region combinations.

Residuals plotted by scenario (Figure 7) suggest some differences in spread, particularly for S1/S2 relative to S3/S4. While this indicates possible scenario-level heteroskedasticity, the model could not support this additional structure without convergence failures. The residuals by region plot (Figure 8) shows some remaining variance differences across regions, but the variation is improved compared to the model without variance adjustment.

We also examined the Q-Q plots to assess the normality assumption. For the random effects (Figure 5), the points closely align the diagonal line with only minor deviations in the lower tails, suggesting the normality assumption for random effects is reasonable. For the residuals (Figure 4), the Q-Q plot shows deviations in the tails, which may be due to repeated identical travel time estimates for certain scenarios or the discrete nature of the response variable. The central portion aligns closely with the theoretical line, indicating that the normality assumption is approximately satisfied for most observations.

# Results

From the logistic regression results (Table 2), we estimated the probability that a call’s estimated travel time would change relative to the baseline for each scenario. As shown in Table 3, 25.4% of calls exhibited a change under Scenario 1, 23.6% under Scenario 2, 10.8% under Scenario 3, and 9.3% under Scenario 4. This indicates that the majority of calls are unaffected by ambulance redistribution across all scenarios, which is an important consideration when evaluating the overall effectiveness and operational impact of each proposed strategy.

To quantify the magnitude of change in estimated travel time for calls that were affected, we computed estimated marginal means using the `emmeans()` function in R. As shown in Table 5, Scenario 3 has the lowest estimated marginal mean of –41.07 seconds, indicating that it reduces estimated travel time by approximately 41 seconds on average compared to the current setup. However, this effect is not statistically significant at the 0.05 level (p = 0.1138). Thus, while Scenario 3 appears to perform best among the four proposals, the overall improvement is not strong enough to conclude a statistically significant benefit at the county-wide level.

When evaluating results by region (Table 6), we observed substantial variation across regions. In the Central and South regions, all scenarios result in positive estimated marginal means, indicating longer travel times compared to the baseline. This is expected, as the scenarios reallocate an ambulance from the Central or South region to the North. In contrast, the North region experiences substantial improvements, with Scenario 3 achieving the largest reduction in estimated travel time (-477.7 seconds, p = 0). Scenario 1 yields a similar reduction, while Scenarios 2 and 4 perform less favorably, suggesting that moving an ambulance to the near north site is more effective than moving it farther away. These differences in fitted values across regions and scenarios are illustrated in Figure 9.

we can see further evidence of the fact that there is a region-by-region difference in fitted estimated travel times for each scenario based on our LMM. General trends for the differences in ETT are also visible, such as the drastically lower fitted ETTs for the North region when compared to the Central and South regions.

Overall, Scenario 3 provides the greatest improvement in the region it is intended to benefit (North), but its benefits at the county level are limited by negative impacts on the Central and South regions and the relatively small proportion of calls that actually experience a change.

# Limitations and Future Directions

Our analysis has several limitations arising from both modeling assumptions and data constraints. First, the residuals grouped by scenario (Figure 7) show slight differences in spread, suggesting potential scenario-level heteroskedasticity not fully captured by our variance structure. Additionally, although the Q-Q plots (Figures 4 and 5) show that residuals generally follow a normal distribution, tail deviations indicate minor violations of the normality assumption. These deviations may result from the discrete nature of travel time differences and repeated identical values across scenarios.

The model also does not incorporate external factors that influence real-world EMS response times, because these were either unavailable in the dataset or could not be incorporated without strong assumptions. These include traffic conditions, rush-hour patterns, road closures, seasonal effects, and staffing availability. Without these factors, our estimates likely underestimate the true variability in response times.

Further limitations relate to input assumptions and model structure. The estimated travel times are based on a single best-guess value from Google Maps and do not capture real-time fluctuations. Our variance modeling accounted only for regional differences, although other sources, such as call urgency, may also contribute to variability. Finally, the dispatch rule used was intentionally simplified and does not fully reflect the complexity of real EMS operations, which are influenced by concurrent calls, on-the-ground decision making, and staffing constraints.

Future work includes integrating dynamic factors such as road conditions, staffing patterns, traffic, and call urgency (emergency vs. non-emergency) into the dispatch rule to more accurately reflect operational decision-making. We could also refine the estimated travel times by calibrating Google Maps predictions to match observed response times or by incorporating multiple travel time estimates rather than relying on a single best-guess value. These enhancements would produce a more realistic and informative model that evaluates optimal ambulance allocation not only by region, but also on call severity and real-time conditions.

# Conclusion

Based on our analyses, if Vance County aims to improve response times in the North region, the optimal reallocation is Scenario 3, which moves one ambulance from the Central station to the Near North station. Under this scenario, approximately 10.8% of calls experience a change in estimated travel time relative to the current setup. Among those affected calls, Scenario 3 yields an average reduction of about 41 seconds compared to baseline; however, this overall effect is not statistically significant due to increased travel times in the Central and South regions, from which ambulance resources were removed. When focusing specifically on the North region, Scenario 3 produces a substantial improvement, reducing travel times by an estimated 478 seconds (approximately 8 minutes), which is operationally meaningful in emergency response contexts where outcomes depend critically on timely arrival.

In summary, reallocating an ambulance from Central to Near North significantly improves response times in the North region but introduces trade-offs in other regions and affects only a limited proportion of calls. Given these considerations, we recommend that Vance County weigh the regional benefits against potential losses in coverage elsewhere, as well as the costs and equity implications of reallocating resources.

\pagebreak

# Appendix

```{r include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(stringr)
library(lme4)
library(emmeans)
library(kableExtra)
library(broom)
library(nlme)
library(patchwork)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load-data}
load("./emsData.RData")
```

```{r clean-data}
# remove duplicated entries of the same call (5 duplicates)
x <- x |>
  distinct(VEH.GRID, DT.DISP, .keep_all = TRUE)

# for other visualizations
x <- x |>
  mutate(
    # actual observed time
    actual_time = as.numeric(difftime(DT.ARRIVE, DT.DISP, units = "secs")),

    # pick the correct estimate from each provider
    est_UA = case_when(
      BASE.NAME == "Company 1" ~ eTT.UA.So,
      BASE.NAME == "Company 9" ~ eTT.UA.Ce,
      TRUE ~ NA_real_
    ),
    est_Pe = case_when(
      BASE.NAME == "Company 1" ~ eTT.Pe.So,
      BASE.NAME == "Company 9" ~ eTT.Pe.Ce,
      TRUE ~ NA_real_
    ),
    est_Op = case_when(
      BASE.NAME == "Company 1" ~ eTT.Op.So,
      BASE.NAME == "Company 9" ~ eTT.Op.Ce,
      TRUE ~ NA_real_
    ),
    est_BG = case_when(
      BASE.NAME == "Company 1" ~ eTT.BG.So,
      BASE.NAME == "Company 9" ~ eTT.BG.Ce,
      TRUE ~ NA_real_
    )
  )

act_est <- x |>
  select(actual_time, est_UA, est_Pe, est_Op, est_BG, BASE.NAME) |>
  pivot_longer(
    cols = starts_with("est_"),
    names_to = "Estimator",
    values_to = "est_time"
  )
```

```{r fig-1, fig.cap="EMS call location and response times across Vance County"}
library(dplyr)
library(sf)
library(ggplot2)
library(tigris)

options(tigris_use_cache = TRUE)

vance_data <- counties(state = "NC", year = 2024, class = "sf") |> filter(GEOID == "37181")

x_modified <- x |>
  mutate(obsTTmodified = as.numeric(observedTT, units = "mins"))

coords_df<- st_as_sf(x_modified, coords = c("REF.GPS.LON","REF.GPS.LAT"), crs = 4326, remove = FALSE) |> st_transform(st_crs(vance_data))


road_df <- roads(state = "NC", county = "Vance", year = 2024, class = "sf")

library(dplyr)
library(sf)
library(ggplot2)
library(tigris)

options(tigris_use_cache = TRUE)

vance_data <- counties(state = "NC", year = 2024, class = "sf") |> filter(GEOID == "37181")

x_modified <- x |>
  mutate(obsTTmodified = as.numeric(observedTT, units = "mins"))

coords_df<- st_as_sf(x_modified, coords = c("REF.GPS.LON","REF.GPS.LAT"), crs = 4326, remove = FALSE) |> st_transform(st_crs(vance_data))


road_df <- roads(state = "NC", county = "Vance", year = 2024, class = "sf")


plot_save <- ggplot() +
  geom_sf(data = vance_data, fill = NA, color = "black", linewidth = 0.5) + geom_sf(data = road_df, color = "grey80", linewidth = 0.2) +
  geom_sf(data = coords_df, aes(color = obsTTmodified), size = 1.8) +
  scale_color_viridis_c(name = "Observed EMS Travel Time (minutes)", na.value = "grey80") +
  coord_sf(xlim = st_bbox(vance_data)[c("xmin","xmax")],
           ylim = st_bbox(vance_data)[c("ymin","ymax")], expand = FALSE) +
  labs(title= "Observed Travel Times of Vance County EMS in minutes")+
  theme_minimal(base_size = 12) +
  theme(panel.grid.major = element_blank(),
        axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())

plot_save



```

```{r fig-3, fig.cap="Comparison of different travel time estimators"}
act_est <- act_est |>
  mutate(error = actual_time - est_time)

ggplot(act_est, aes(x = Estimator, y = error)) +
  geom_boxplot(width = 0.5, outlier.alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_cartesian(ylim = c(-500, 500)) +
  labs(
    title = "Error Distribution by Estimator",
    y = "Error (actual − estimated)",
    x = "Estimator"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5))
```

```{r}
metrics <- act_est |>
  group_by(Estimator) |>
  summarise(
    MAE  = mean(abs(actual_time - est_time), na.rm = TRUE),
    RMSE = sqrt(mean((actual_time - est_time)^2, na.rm = TRUE)),
    Bias = mean(actual_time - est_time, na.rm = TRUE)
  )

metrics |>
  kable(caption = "Metrics of different travel time estimators shows BG is optimal") |>
  kable_styling(latex_options = "HOLD_position")
```

```{r dispatch-rule}

# order in dispatch time
x <- x |> arrange(DT.DISP)

# build availability matrix
avail_matrix <- outer(x$DT.DISP, x$DT.AVAILABLE, FUN = "<")
avail_matrix[upper.tri(avail_matrix, diag = TRUE)] <- FALSE

dispatch_scenario <- function(x, avail_matrix, scenario_caps, ett_map, label) {
  # scenario_caps: named vector of capacities, e.g. c(South=1, Central=3, NN=2)
  # ett_map: named vector of column names in x giving ETTs for each station
  
  n_calls <- nrow(x)
  used_station <- rep(NA_character_, n_calls)
  dispatch_ett <- rep(NA_real_, n_calls)
  
  for (i in seq_len(n_calls)) {
    # reset station availability for this call
    avail_veh <- scenario_caps
    
    # check conflicts with earlier calls
    conflict_cols <- which(avail_matrix[i, ])
    if (length(conflict_cols) > 0) {
      for (j in conflict_cols) {
        st <- used_station[j]
        if (!is.na(st)) {
          avail_veh[st] <- avail_veh[st] - 1
        }
      }
    }
    
    # choose station with shortest ETT among those with capacity left
    min_ett <- Inf
    best_station <- NA
    
    for (st in names(scenario_caps)) {
      if (avail_veh[st] > 0) {
        ett_val <- x[[ett_map[st]]][i]
        if (ett_val < min_ett) {
          min_ett <- ett_val
          best_station <- st
        }
      }
    }
    
    used_station[i] <- best_station
    dispatch_ett[i] <- min_ett
  }
  
  x[[paste0(label, "_station")]] <- used_station
  x[[paste0(label, "_ETT_DISPATCH")]] <- dispatch_ett
  return(x)
}

# Station → ETT column mapping
ett_map <- c(South="eTT.BG.So", Central="eTT.BG.Ce", NN="eTT.BG.NN", FN="eTT.BG.FN")

# Define scenarios (capacities per station)
S0_caps <- c(South=1, Central=3, NN=0, FN=0)
S1_caps <- c(South=0, Central=3, NN=1, FN=0)
S2_caps <- c(South=0, Central=3, NN=0, FN=1)
S3_caps <- c(South=1, Central=2, NN=1, FN=0)
S4_caps <- c(South=1, Central=2, NN=0, FN=1)

# Apply
x <- dispatch_scenario(x, avail_matrix, S0_caps, ett_map, "S0")
x <- dispatch_scenario(x, avail_matrix, S1_caps, ett_map, "S1")
x <- dispatch_scenario(x, avail_matrix, S2_caps, ett_map, "S2")
x <- dispatch_scenario(x, avail_matrix, S3_caps, ett_map, "S3")
x <- dispatch_scenario(x, avail_matrix, S4_caps, ett_map, "S4")
```

```{r}
plot_data <- x |>
  pivot_longer(cols = starts_with("S") & ends_with("ETT_DISPATCH"),
               names_to = "Scenario",
               values_to = "ETT") |>
  mutate(ETT_min = ETT / 60,
         DelayGroup = cut(
           ETT_min,
           breaks = c(-Inf, 6, 9, 15, Inf),
           labels = c("0–6 min", "7–9 min", "10–15 min", ">15 min")))

counts <- plot_data |>
  group_by(Scenario, DelayGroup) |>
  summarise(N = n(), .groups = "drop")
```

```{r fig-4, fig.cap="Estimated travel times intervals by scenario"}
counts$Scenario <- gsub("_ETT_DISPATCH", "", counts$Scenario)

ggplot(counts, aes(x = DelayGroup, y = N, fill = Scenario)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d(option = "D", end = 0.9) +
  labs(title = "Counts of Estimated Travel Time Intervals by Scenario",
       x = "Estimated Travel Time", y = "Number of Calls",
       fill = "Scenario") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

```{r model-df}

x <- x |>
  mutate(region = case_when(
    REF.GRID == "1 North"~"North",
    REF.GRID =="2 Central"~"Central",
    REF.GRID =="3 South"~"South"
))

model_df <- x |>
  transmute(
    row_val = row_number(), region, DISPATCH.PRIORITY.NAME,
    across(matches("^S\\d+_ETT_DISPATCH$"))
  ) |>
  pivot_longer(
    cols = matches("^S\\d+_ETT_DISPATCH$"),
    names_to = "Scenario",
    values_to = "ETT_sec"
  ) |>
  mutate(
    Scenario = str_remove(Scenario, "_ETT_DISPATCH$"),
    Scenario = factor(Scenario),
    region = factor(region))

# check if each row differs from baseline
model_df <- model_df |>
  group_by(row_val) |>
  mutate(
    base_ETT = ETT_sec[Scenario == "S0"][1],
    change_flag = ETT_sec != base_ETT
  ) |>
  ungroup() |>
  filter(Scenario != "S0")
```

```{r logistic-model}
model_logit <- glm(change_flag ~ Scenario,
                   data = model_df, 
                   family = binomial)
kable(
  tidy(model_logit, conf.int = TRUE, conf.level = 0.95),
  digits = 3,
  caption = "Model output for logistic model of scenarios"
) |> 
  kable_styling(latex_options = "HOLD_position")

new_data <- data.frame(
  Scenario = c("S1", "S2", "S3", "S4")
)

new_data$predicted_prob <- predict(model_logit, newdata = new_data, type = "response")

kable(new_data, digits = 3, 
      caption = "Predicted probabilities of differences from baseline") |> 
  kable_styling(latex_options = "HOLD_position")
```

```{r lmm}
changed_df <- model_df |> filter(change_flag)

model_lmm <- lme(
  (ETT_sec - base_ETT) ~ Scenario*region,
  random = ~1 | row_val,
  weights = varIdent(form = ~1 | region),
  data = changed_df
)
```

```{r}
model_lmm <- lme(
  (ETT_sec - base_ETT) ~ Scenario*region,
  random = ~1 | row_val,
  weights = varIdent(form = ~1 | region),
  data = changed_df
)
```

```{r}
model_gls <- gls(
  (ETT_sec - base_ETT) ~ Scenario*region,
  weights = varIdent(form = ~1 | Scenario*region),
  data = changed_df
)

anova_res <- anova(model_lmm, model_gls)
anova_res <- anova_res[, !(names(anova_res) %in% c("call"))]

kable(anova_res, caption = "Model Comparison: LMM vs GLS", digits = 3) |>
  kable_styling(latex_options = "HOLD_position")
```

```{r fig-5, fig.cap="QQ plot for residuals roughly follows diagnol line"}

# Residuals Q-Q plot
qqnorm(residuals(model_lmm), main = "Residuals")
qqline(residuals(model_lmm), col = "red")

```

```{r fig-6, fig.cap="QQ plot for random effects follows diagnol line"}
# Random effects Q-Q plot
re <- ranef(model_lmm)
qqnorm(re[,1], main = "Random Effects")
qqline(re[,1], col = "red")
```

```{r fig-7, fig.cap="Residuals vs fitted values are roughly randomly scattered"}
changed_df$fitted <- fitted(model_lmm)
changed_df$resid  <- resid(model_lmm, type = "normalized")

p1 <- ggplot(changed_df, aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted values",
       y = "Residuals") +
  theme_minimal()

p2 <- ggplot(changed_df, aes(x = Scenario, y = resid)) +
  geom_boxplot(alpha = 0.5) +
  theme_minimal() +
  labs(y = "Residuals", x = "Scenario", title = "Residuals by Scenario")

p3 <- ggplot(changed_df, aes(x = region, y = resid)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Residuals by Region",
       x = "Region", y = "Residuals") +
  theme_minimal()

p1

```

```{r fig-8, fig.cap="Boxplot of residuals by scenario shows variation across scenarios"}
p2
```

```{r fig-9, fig.cap="Boxplots of residuals by region show variantion across regions"}
p3
```

```{r}
emm <- emmeans(model_lmm, ~ Scenario)
summary(emm, infer = TRUE) |>
  kable(caption = "Estimated marginal means by scenario")

emm_reg <- emmeans(model_lmm, ~ Scenario | region)
summary(emm_reg, infer = TRUE) |>
  kable(caption = "Estimated marginal means by scenario within each region")

```

```{r fig-10, fig.cap="Boxplots of fitted values by region and scenario show scenario variations"}

# effects by category

ggplot(changed_df,aes(x=Scenario,y=fitted,color=Scenario))+
  geom_boxplot()+geom_jitter(aes(y=fitted),alpha=0.3)+facet_wrap("region") +
  theme_minimal() +
  labs(title = "Fitted Values by Region and Scenario",
       y = "Fitted Value")

```

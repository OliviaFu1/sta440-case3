---
title: "Case 3: Vance County EMS"
author: "Steph Reinke, Olivia Fu, Srika Gopal"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: false
  bookdown::html_document2:
    toc: true
    number_sections: true
    fig_caption: true
editor: visual
---

# Background and Motivation

Emergency medical service (EMS) response times can drastically impact patient outcomes. Vance County, North Carolina is a growing county that is interested in evaluating their current EMS ambulance placements. The county has three major regions, the North, Central, and the South. The population is mostly concentrated in the city of Henderson, located in the Central region. There are currently 2 EMS stations, 1 in the South, and 1 in Central. The southern station has 1 ambulance, and the central station has 3. The North does not currently have a station. Thus Vance County is interested in exploring if moving an ambulance to the North would be beneficial. There are two potential locations for an ambulance to be stationed in the North: the Near North and the Far North. We were given five scenarios for ambulance placement:

-   Scenario 0: 1 in South, 3 in Central (Current Placement)

-   Scenario 1: 0 in South, 3 in Central, 1 in Near North

-   Scenario 2: 0 in South, 3 in Central, 1 in Far North

-   Scenario 3: 1 in South, 2 in Central, 1 in Near North

-   Scenario 4: 1 in South, 2 in Central, 1 in Far North

**Research question:** Where should the ambulances be stationed to best serve Vance county?

# Data and Exploratory Analysis

To answer this question we examined a dataset with real EMS call data. Select information was withheld or changed, such as dates and addresses for HIPAA compliance. However for the purposes of our analysis those changes are not relevant. The data has information for each call and API pulled travel times from Google Maps. We were provided with four types of estimates from Google Maps (best guess, optimistic, pessimistic, and unadjusted) for each station including the two proposed Northern stations to each call.

We started by exploring the distribution of calls throughout Vance County. We plotted call locations on a map of Vance County and colored the points according to the response time (Figure). The points are densely concentrated in the Central region around the city of Henderson. The points become more sparse the further they are from Henderson, resulting in sparsely concentrated points in the far North and far South. Response times are shorter in the Central region and tend to be longer in the North and the South. 

We were provided with four different Google Maps travel times. Ultimately we chose to use BG (best guess) estimates because it had the lowest bias (Table). This can be seen visually (Figure) because the interquartile range (the box) is the most centered at 0 for BG in comparison to the other estimates. 

In order to simulate EMS calls with the given data, we had to determine a rule for which ambulance to dispatch from which station. First we use the availability matrix to detect overlapping calls with earlier dispatches. We then adjust each station’s available vehicles by subtracting those already assigned to conflicts. Then from the stations with vehicles still available, dispatch from the one offering the shortest estimated travel time to the call. 

Once we determined our dispatch rule, we were able to calculate estimated travel times for the calls according to the different scenarios. Looking at different intervals of estimated travel times, we can see that Scenario 3 appears to have the lowest (fastest) estimated travel times. This suggests that Scenario 3 may be the optimal choice. 

# Model Rationale, Implementation, and Evaluation

## Rationale & Selection

We selected a two-stage modeling approach: a logistic regression to model whether estimated travel time changes from the baseline scenario, followed by a linear mixed-effects model to quantify how travel time changes when it does differ. This approach is justified both by the data structure and the nature of our dispatch system. In our simulation, many calls have identical estimated travel times across all four proposed scenarios and the baseline (S0). For example, calls located in the central often have the same optimal dispatch station under all scenarios, resulting in no variation. Including these repeated values directly in a continuous-response model would violate normality and constant variance assumptions due to the discrete mass at zero differences.

To address this, our first model is a logistic regression predicting whether estimated travel time differs from baseline (change vs. no change). This allows us to estimate the probability that each scenario leads to a change in dispatch outcome.

Conditional on a change occurring, we then model the magnitude of that change using a linear mixed-effects model. The response variable is the difference in estimated travel time relative to baseline. We include a Scenario\*Region interaction to assess both overall scenario effects and whether their impacts differ across geographic regions. Because each call contributes multiple observations (one per scenario), there is clear grouping in the data. Therefore, we include a random intercept at the call level to account for within-call correlation.

Exploratory residual analysis revealed heteroskedasticity across regions, so we incorporate region-specific residual variances using a varIdent variance structure. Attempts to also model variance by scenario resulted in singular fits, likely due to limited variability or nesting of scenarios within call-level random effects. A competing GLS model without random effects and with Scenario\*Region variance structure had substantially worse AIC/BIC values (Table 1), which supports that accounting for call-level correlation and regional heterogeneity provides a better fit.

## Implementation

For the logistic model, we created a binary indicator of whether estimated travel time changed from baseline and fit a generalized linear model using the glm() function in R with a binomial family and scenario as the predictor.

For the linear mixed-effects stage, we retained only rows where travel time differed from baseline and modeled the continuous difference using the lme() function in the nlme package. We specified a random intercept for each call (random = \~1 \| row_val) and allowed the residual variance to differ by region using weights = varIdent(form = \~1 \| region).

## Evaluation

To evaluate whether the model provided a good fit for the data, we examined multiple residual plots (Figure 4). The residuals are normalized to account for the model’s variance structure. In the residuals vs. fitted values plot, the residuals are randomly scattered around zero without clear patterns or clustering, which suggests that the model’s mean structure is appropriate and that the variance has been reasonably modeled. The horizontal layering is expected due to the discrete set of fitted values from the scenario–region combinations.

Residuals plotted by scenario suggest some differences in spread, particularly for S1/S2 relative to S3/S4. While this indicates possible scenario-level heteroskedasticity, the model could not support this additional structure without convergence failures. The residuals by region plot shows some remaining variance differences across regions, but the variation is improved compared to the model without variance adjustment.

We also examined the Q-Q plots to assess the normality assumption (Figure 5). For the random effects, the points closely align the diagonal line with only minor deviations in the lower tails, suggesting the normality assumption for random effects is reasonable. For the residuals, the Q-Q plot shows deviations in the tails, which may be due to repeated identical travel time estimates for certain scenarios or the discrete nature of the response variable. The central portion aligns closely with the theoretical line, indicating that the normality assumption is approximately satisfied for most observations.

# Results

From the logistic regression results (Table 2), we estimated the probability that a call’s estimated travel time would change relative to the baseline for each scenario. As shown in Table 3, 25.4% of calls exhibited a change under Scenario 1, 23.6% under Scenario 2, 10.8% under Scenario 3, and 9.3% under Scenario 4. This indicates that the majority of calls are unaffected by ambulance redistribution across all scenarios, which is an important consideration when evaluating the overall effectiveness and operational impact of each proposed strategy.

To quantify the magnitude of change in estimated travel time for calls that were affected, we computed estimated marginal means using the emmeans() function in R. As shown in Table 5, Scenario 3 has the lowest estimated marginal mean of –41.07 seconds, indicating that it reduces estimated travel time by approximately 41 seconds on average compared to the current setup. However, this effect is not statistically significant at the 0.05 level (p = 0.1138). Thus, while Scenario 3 appears to perform best among the four proposals, the overall improvement is not strong enough to conclude a statistically significant benefit at the county-wide level.

When evaluating results by region (Table 6), we observed substantial variation across regions. In the Central and South regions, all scenarios result in positive estimated marginal means, indicating longer travel times compared to the baseline. This is expected, as the scenarios reallocate an ambulance from the Central or South region to the North. In contrast, the North region experiences substantial improvements, with Scenario 3 achieving the largest reduction in estimated travel time (-477.7 seconds, p = 0). Scenario 1 yields a similar reduction, while Scenarios 2 and 4 perform less favorably, suggesting that moving an ambulance to the near north site is more effective than moving it farther away.

Overall, Scenario 3 provides the greatest improvement in the region it is intended to benefit (North), but its benefits at the county level are limited by negative impacts on the Central and South regions and the relatively small proportion of calls that actually experience a change.


# Limitations and Conclusion

There are several shortcomings of our analysis, some of which are due to model flaws while others are due to data limitations. First of all, our model stratified the random residual vs. fitted scattering, but there is some slight ambiguity in our residuals plotted by scenario that leaves a possibility of scenario-level heteroskedasticity. While our model has reasonably met the normally distributed residuals assumption via the QQ plot, there is still some deviation in the tail ends of the plot which could point to model weakness in terms of normality.

Additionally, our model does not account for certain outside factors that were omitted from the provided data and could not be extracted without heavy assumption. Factors like traffic, rush hours, and road closures which very well could affect ambulance response times are not accounted for by our model or analysis. Additionally, variance in ambulance response times dependent on the month/date of the year is very possible yet not a feature of our model. Furthermore, EMT and ambulance staffing patterns which is an additional factor that could affect an ambulance’s ability to report to a call even if the vehicle itself is available is something that could not be assumed from the provided data.

Other shortcomings of our analysis beyond unaccounted factors include ETT input limitations, variance modeling, and dispatch rule simplicity. The estimated travel time (ETT) inputs are based on single best-guess estimates generated from Google Maps data, so this does not take nuances in travel time due to aforementioned factors into consideration. Our variance modeling was only structured around the regional differences for scenario reallocation, even though other factors like call urgency (emergency vs. non emergency) could affect variability. Lastly, our dispatch rule is sufficient, yet simplistic and lacks consideration of nuances and additional factors (as mentioned above). While dispatching based on a simple queueing system model was ideal for analysis, this is not indicative of real-life ambulance dispatch scenarios. Real-life dispatching can be wildly unpredictable, if not dependent on many other factors like road conditions and staffing patterns.

To improve our model for the future, we might consider fitting additional models that account for additional factors of complexity if provided, such as road conditions, staffing patterns, and traffic. We would ideally also incorporate the given urgency of calls (emergency vs non-emergency) to update our dispatch rule. We could also add contrasts to our estimated marginal mean travel time calculations. This would provide a more informative model and analysis that not only accounts for optimal ambulance reallocation by region, but also by how dire the call was.

Based on the above analyses and our modeling results, we conclude that the overall optimal reallocation resulting in a reduction of ambulance response time is Scenario 3. Scenario 3 is to move an ambulance from the Central station to the Near North station in Vance County. This reallocation results in a % reduction in marginal mean estimated travel times from the baseline of Scenario 0 (the current ambulance allocation in Vance County). We see the lowest overall marginal mean estimated travel times for Scenario 3, though, as discussed above, the optimal Scenario for Central and North stations evaluated individually would be Scenario 1. With this change in ambulance allocation to Scenario 3, Vance County can expect to see a decrease in marginal mean ETT of \_\_\_ min, which is a substantial amount when discussing the urgency of emergency response situations whose outcomes are dependent on minutes, perhaps even seconds.

\pagebreak

# Appendix

```{r include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(stringr)
library(lme4)
library(emmeans)
library(kableExtra)
library(broom)
library(nlme)
library(patchwork)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load-data}
load("./emsData.RData")
```

```{r clean-data}
# remove duplicated entries of the same call (5 duplicates)
x <- x |>
  distinct(VEH.GRID, DT.DISP, .keep_all = TRUE)
```

```{r fig-1, fig.cap="EMS call location and response times across Vance County"}
library(dplyr)
library(sf)
library(ggplot2)
library(tigris)

options(tigris_use_cache = TRUE)

vance_data <- counties(state = "NC", year = 2024, class = "sf") |> filter(GEOID == "37181")

x_modified <- x |>
  mutate(obsTTmodified = as.numeric(observedTT, units = "mins"))

coords_df<- st_as_sf(x_modified, coords = c("REF.GPS.LON","REF.GPS.LAT"), crs = 4326, remove = FALSE) |> st_transform(st_crs(vance_data))


road_df <- roads(state = "NC", county = "Vance", year = 2024, class = "sf")

library(dplyr)
library(sf)
library(ggplot2)
library(tigris)

options(tigris_use_cache = TRUE)

vance_data <- counties(state = "NC", year = 2024, class = "sf") |> filter(GEOID == "37181")

x_modified <- x |>
  mutate(obsTTmodified = as.numeric(observedTT, units = "mins"))

coords_df<- st_as_sf(x_modified, coords = c("REF.GPS.LON","REF.GPS.LAT"), crs = 4326, remove = FALSE) |> st_transform(st_crs(vance_data))


road_df <- roads(state = "NC", county = "Vance", year = 2024, class = "sf")


plot_save <- ggplot() +
  geom_sf(data = vance_data, fill = NA, color = "black", linewidth = 0.5) + geom_sf(data = road_df, color = "grey80", linewidth = 0.2) +
  geom_sf(data = coords_df, aes(color = obsTTmodified), size = 1.8) +
  scale_color_viridis_c(name = "Observed EMS Travel Time (minutes)", na.value = "grey80") +
  coord_sf(xlim = st_bbox(vance_data)[c("xmin","xmax")],
           ylim = st_bbox(vance_data)[c("ymin","ymax")], expand = FALSE) +
  labs(title= "Observed Travel Times of Vance County EMS in minutes")+
  theme_minimal(base_size = 12) +
  theme(panel.grid.major = element_blank(),
        axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())

plot_save



```

```{r fig-3, fig.cap="Comparison of different travel time estimators"}

```

```{r dispatch-rule}

# order in dispatch time
x <- x |> arrange(DT.DISP)

# build availability matrix
avail_matrix <- outer(x$DT.DISP, x$DT.AVAILABLE, FUN = "<")
avail_matrix[upper.tri(avail_matrix, diag = TRUE)] <- FALSE

dispatch_scenario <- function(x, avail_matrix, scenario_caps, ett_map, label) {
  # scenario_caps: named vector of capacities, e.g. c(South=1, Central=3, NN=2)
  # ett_map: named vector of column names in x giving ETTs for each station
  
  n_calls <- nrow(x)
  used_station <- rep(NA_character_, n_calls)
  dispatch_ett <- rep(NA_real_, n_calls)
  
  for (i in seq_len(n_calls)) {
    # reset station availability for this call
    avail_veh <- scenario_caps
    
    # check conflicts with earlier calls
    conflict_cols <- which(avail_matrix[i, ])
    if (length(conflict_cols) > 0) {
      for (j in conflict_cols) {
        st <- used_station[j]
        if (!is.na(st)) {
          avail_veh[st] <- avail_veh[st] - 1
        }
      }
    }
    
    # choose station with shortest ETT among those with capacity left
    min_ett <- Inf
    best_station <- NA
    
    for (st in names(scenario_caps)) {
      if (avail_veh[st] > 0) {
        ett_val <- x[[ett_map[st]]][i]
        if (ett_val < min_ett) {
          min_ett <- ett_val
          best_station <- st
        }
      }
    }
    
    used_station[i] <- best_station
    dispatch_ett[i] <- min_ett
  }
  
  x[[paste0(label, "_station")]] <- used_station
  x[[paste0(label, "_ETT_DISPATCH")]] <- dispatch_ett
  return(x)
}

# Station → ETT column mapping
ett_map <- c(South="eTT.BG.So", Central="eTT.BG.Ce", NN="eTT.BG.NN", FN="eTT.BG.FN")

# Define scenarios (capacities per station)
S0_caps <- c(South=1, Central=3, NN=0, FN=0)
S1_caps <- c(South=0, Central=3, NN=1, FN=0)
S2_caps <- c(South=0, Central=3, NN=0, FN=1)
S3_caps <- c(South=1, Central=2, NN=1, FN=0)
S4_caps <- c(South=1, Central=2, NN=0, FN=1)

# Apply
x <- dispatch_scenario(x, avail_matrix, S0_caps, ett_map, "S0")
x <- dispatch_scenario(x, avail_matrix, S1_caps, ett_map, "S1")
x <- dispatch_scenario(x, avail_matrix, S2_caps, ett_map, "S2")
x <- dispatch_scenario(x, avail_matrix, S3_caps, ett_map, "S3")
x <- dispatch_scenario(x, avail_matrix, S4_caps, ett_map, "S4")
```

```{r}
plot_data <- x |>
  pivot_longer(cols = starts_with("S") & ends_with("ETT_DISPATCH"),
               names_to = "Scenario",
               values_to = "ETT") |>
  mutate(ETT_min = ETT / 60,
         DelayGroup = cut(
           ETT_min,
           breaks = c(-Inf, 6, 9, 15, Inf),
           labels = c("0–6 min", "7–9 min", "10–15 min", ">15 min")))

counts <- plot_data |>
  group_by(Scenario, DelayGroup) |>
  summarise(N = n(), .groups = "drop")
```

```{r fig-4, fig.cap="Estimated travel times intervals by scenario"}
counts$Scenario <- gsub("_ETT_DISPATCH", "", counts$Scenario)

ggplot(counts, aes(x = DelayGroup, y = N, fill = Scenario)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d(option = "D", end = 0.9) +
  labs(title = "Counts of Estimated Travel Time Intervals by Scenario",
       x = "Estimated Travel Time", y = "Number of Calls",
       fill = "Scenario") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

```{r model-df}

x <- x |>
  mutate(region = case_when(
    REF.GRID == "1 North"~"North",
    REF.GRID =="2 Central"~"Central",
    REF.GRID =="3 South"~"South"
))

model_df <- x |>
  transmute(
    row_val = row_number(), region, DISPATCH.PRIORITY.NAME,
    across(matches("^S\\d+_ETT_DISPATCH$"))
  ) |>
  pivot_longer(
    cols = matches("^S\\d+_ETT_DISPATCH$"),
    names_to = "Scenario",
    values_to = "ETT_sec"
  ) |>
  mutate(
    Scenario = str_remove(Scenario, "_ETT_DISPATCH$"),
    Scenario = factor(Scenario),
    region = factor(region))

# check if each row differs from baseline
model_df <- model_df |>
  group_by(row_val) |>
  mutate(
    base_ETT = ETT_sec[Scenario == "S0"][1],
    change_flag = ETT_sec != base_ETT
  ) |>
  ungroup() |>
  filter(Scenario != "S0")
```

```{r logistic-model}
model_logit <- glm(change_flag ~ Scenario,
                   data = model_df, 
                   family = binomial)
kable(
  tidy(model_logit, conf.int = TRUE, conf.level = 0.95),
  digits = 3,
  caption = "Model output for logistic model of scenarios"
) |> 
  kable_styling(latex_options = "HOLD_position")

new_data <- data.frame(
  Scenario = c("S1", "S2", "S3", "S4")
)

new_data$predicted_prob <- predict(model_logit, newdata = new_data, type = "response")

kable(new_data, digits = 3, caption = "Predicted probabilities of differences from baseline") |> 
  kable_styling(latex_options = "HOLD_position")
```

```{r lmm}
changed_df <- model_df |> filter(change_flag)

model_lmm <- lme(
  (ETT_sec - base_ETT) ~ Scenario*region,
  random = ~1 | row_val,
  weights = varIdent(form = ~1 | region),
  data = changed_df
)
```

```{r fig-5, fig.cap="QQ plot for residuals roughly follows diagnol line"}

# Residuals Q-Q plot
qqnorm(residuals(model_lmm), main = "Residuals")
qqline(residuals(model_lmm), col = "red")

```

```{r fig-6, fig.cap="QQ plot for random effects follows diagnol line"}
# Random effects Q-Q plot
re <- ranef(model_lmm)
qqnorm(re[,1], main = "Random Effects")
qqline(re[,1], col = "red")
```

```{r fig-7, fig.cap="Residuals vs fitted values are roughly randomly scattered"}
changed_df$fitted <- fitted(model_lmm)
changed_df$resid  <- resid(model_lmm, type = "normalized")

p1 <- ggplot(changed_df, aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted values",
       y = "Residuals") +
  theme_minimal()

p2 <- ggplot(changed_df, aes(x = Scenario, y = resid)) +
  geom_boxplot(alpha = 0.5) +
  theme_minimal() +
  labs(y = "Residuals", x = "Scenario", title = "Residuals by Scenario")

p3 <- ggplot(changed_df, aes(x = region, y = resid)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Residuals by Region",
       x = "Region", y = "Residuals") +
  theme_minimal()

p1

```

```{r fig-8, fig.cap="Boxplot of residuals by scenario shows variation across scenarios"}
p2
```

```{r fig-9, fig.cap="Boxplots of residuals by region show variantion across regions"}
p3
```

```{r}
emm <- emmeans(model_lmm, ~ Scenario)
summary(emm, infer = TRUE) |>
  kable(caption = "Estimated marginal means by scenario")

emm_reg <- emmeans(model_lmm, ~ Scenario | region)
summary(emm_reg, infer = TRUE) |>
  kable(caption = "Estimated marginal means by scenario within each region")

```

```{r fig-10, fig.cap="Boxplots of fitted values by region and scenario show scenario variations"}

# effects by category

ggplot(changed_df,aes(x=Scenario,y=fitted,color=Scenario))+
  geom_boxplot()+geom_jitter(aes(y=fitted),alpha=0.3)+facet_wrap("region") +
  theme_minimal() +
  labs(title = "Fitted Values by Region and Scenario",
       y = "Fitted Value")

```
